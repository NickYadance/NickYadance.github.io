<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><link rel="icon" href="/favicon.ico"/><meta name="description" content="The blog of a programmer who enjoys learning and building things."/><meta property="og:image" content="https://og-image.vercel.app/WuYi&#x27;s%20Blog.png?theme=light&amp;md=0&amp;fontSize=75px&amp;images=https%3A%2F%2Fassets.vercel.com%2Fimage%2Fupload%2Ffront%2Fassets%2Fdesign%2Fnextjs-black-logo.svg"/><meta name="og:title" content="WuYi&#x27;s Blog"/><meta name="twitter:card" content="summary_large_image"/><title>Boltdb数据结构-二进制存储</title><meta name="next-head-count" content="8"/><link data-next-font="" rel="preconnect" href="/" crossorigin="anonymous"/><link rel="preload" href="/_next/static/css/f5bbdd045156ccce.css" as="style" crossorigin=""/><link rel="stylesheet" href="/_next/static/css/f5bbdd045156ccce.css" crossorigin="" data-n-g=""/><link rel="preload" href="/_next/static/css/327bdfcd3e98582f.css" as="style" crossorigin=""/><link rel="stylesheet" href="/_next/static/css/327bdfcd3e98582f.css" crossorigin="" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" crossorigin="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-445a5fe7cadeec28.js" defer="" crossorigin=""></script><script src="/_next/static/chunks/framework-bbecb7d54330d002.js" defer="" crossorigin=""></script><script src="/_next/static/chunks/main-6e8ee6ae7cc0a14c.js" defer="" crossorigin=""></script><script src="/_next/static/chunks/pages/_app-25345a12794bca3a.js" defer="" crossorigin=""></script><script src="/_next/static/chunks/996-5abd08ae305d436b.js" defer="" crossorigin=""></script><script src="/_next/static/chunks/284-919fb0c78b7b87bc.js" defer="" crossorigin=""></script><script src="/_next/static/chunks/pages/posts/%5Bid%5D-30a9d36a22da8e83.js" defer="" crossorigin=""></script><script src="/_next/static/tBDcWIf9tU2_6gXjzKBx-/_buildManifest.js" defer="" crossorigin=""></script><script src="/_next/static/tBDcWIf9tU2_6gXjzKBx-/_ssgManifest.js" defer="" crossorigin=""></script></head><body><div id="__next"><div class="layout_container__FUycR"><header class="layout_header__SFlEE"></header><main><article><h1 class="utils_headingXl__zlq1q">Boltdb数据结构-二进制存储</h1><div class="utils_lightText__B_gv3"><time dateTime="2023-12-26">December 26, 2023</time></div><div><h2>概览</h2>
<p>本文结合Boltdb的<a href="https://jaydenwen123.github.io/boltdb/chapter1/boltdb%E7%9A%84%E6%95%B4%E4%BD%93%E6%95%B0%E6%8D%AE%E7%BB%84%E7%BB%87%E7%BB%93%E6%9E%84.html">数据结构预览</a>分析Boltdb的二进制存储文件格式。
<img src="/images/boltdb/boltdb.png" alt="boltdb"></p>
<p>示例程序创建一个db，创建MyBucket并写入两个kv，生成my.db文件后用<a href="https://iamkate.com/code/binary-file-viewer/">二进制文件预览</a>打开进行分析。</p>
<pre><code class="hljs language-go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestMy</span><span class="hljs-params">(t *testing.T)</span></span> {
	<span class="hljs-comment">// Open the my.db data file in your current directory.</span>
	<span class="hljs-comment">// It will be created if it doesn&#x27;t exist.</span>
	db, err := bolt.Open(<span class="hljs-string">&quot;my.db&quot;</span>, <span class="hljs-number">0600</span>, <span class="hljs-literal">nil</span>)
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		log.Fatal(err)
	}
	<span class="hljs-keyword">defer</span> db.Close()

	err = db.Update(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(tx *bolt.Tx)</span></span> <span class="hljs-type">error</span> {
		b, err := tx.CreateBucketIfNotExists([]<span class="hljs-type">byte</span>(<span class="hljs-string">&quot;MyBucket&quot;</span>))
		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
			<span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;create bucket: %s&quot;</span>, err)
		}

		err = b.Put([]<span class="hljs-type">byte</span>(<span class="hljs-string">&quot;name1&quot;</span>), []<span class="hljs-type">byte</span>(<span class="hljs-string">&quot;nicky1&quot;</span>))
		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
			<span class="hljs-keyword">return</span> err
		}

		err = b.Put([]<span class="hljs-type">byte</span>(<span class="hljs-string">&quot;name2&quot;</span>), []<span class="hljs-type">byte</span>(<span class="hljs-string">&quot;nicky2&quot;</span>))
		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
			<span class="hljs-keyword">return</span> err
		}

		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
	})
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		log.Fatal(err)
	}
}
</code></pre>
<h2>page</h2>
<p>page(页)是Boltdb存储的基本单位，由一块固定大小的存储区域组成。我的操作系统默认页大小为16384(16K)即0x4000，因此0x0000~0x4000为第0页，0x4000~0x8000为第1页，以此类推。</p>
<p>Boltdb的页包括页头和一个任意大小的指针ptr。页头中标识了页类型、元素数量、溢出大小等信息，ptr用来指向页头的结束地址，或者说是页内容的开始地址，这样代码中可以用ptr跳过页头直接获取页面的内容。</p>
<p>值得注意的是除了物理的、实际存在的page，boltdb还会构造虚拟页来辅助存储，这些虚拟页并没有真实的页Id，在后续的bucket中会看到。</p>
<h2>meta</h2>
<p>第0x00，0x01页是meta页，负责存储meta信息，为什么有两个meta页我们在分析完Boltdb事务后会了解。</p>
<p>meta0存储了rootBucket的值。Boltdb的数据存储是一颗B+树，rootBucket指向这颗B+树的根节点所在的页id，示例中就是id为0x04的page。</p>
<p><img src="/images/boltdb/meta0.png" alt="meta0"></p>
<figure>meta0原始数据</figure>
<table style="border-collapse:collapse;border-spacing:0" class="tg"><tbody><tr><td style="border-color:black;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal">offset</td><td style="border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal">0</td><td style="border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal">+1</td><td style="border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal">+2</td><td style="border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal">+3</td><td style="border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal">+4</td><td style="border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal">+5</td><td style="border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal">+6</td><td style="border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal">+7</td><td style="border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal">+8</td><td style="border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal">+9</td><td style="border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal">+a</td><td style="border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal">+b</td><td style="border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal">+c</td><td style="border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal">+d</td><td style="border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal">+e</td><td style="border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal">+f</td></tr><tr><td style="border-color:black;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal">0x00000000</td><td style="border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal" colspan="8">id=0<br><span style="font-weight:400;font-style:normal">页Id</span></td><td style="border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal" colspan="2">flag=0x04<br>页标识<br><br></td><td style="border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal" colspan="2"><span style="font-weight:400;font-style:normal">count=0</span><br>页内元素项</td><td style="border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal" colspan="4"><span style="font-weight:400;font-style:normal">overflow=0</span><br>页溢出，如果数据太大单页放不下，<br>此数值用来标识溢出了多少页</td></tr><tr><td style="border-color:black;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal">0x00000010</td><td style="border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal" colspan="4">magic=0xed0cdaed</td><td style="border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal" colspan="4">version=0x02</td><td style="border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal" colspan="4">pagesize=0x4000=16384<br><br>页大小，默认取操作系统页大小</td><td style="border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal" colspan="4"><span style="font-weight:400;font-style:normal">flags=0</span></td></tr><tr><td style="border-color:black;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal">0x00000020</td><td style="border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal" colspan="16"><span style="font-weight:400;font-style:normal;color:#FE0000">rootBucket=0x04</span><br><span style="color:#FE0000">B+树根节点所在的页Id</span></td></tr><tr><td style="border-color:black;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal">0x00000030</td><td style="border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal" colspan="8">freelist_id=0x05<br>自由表的页Id，自由表由空闲页Id组成</td><td style="border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal" colspan="8">page_id=0x06</td></tr><tr><td style="border-color:black;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal">0x00000040</td><td style="border-color:black;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal" colspan="8">tx_id=0x02</td><td style="border-color:black;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal" colspan="8">校验和</td></tr></tbody></table>
<figure>meta0结构化数据</figure>
<p>meta1与meta0不同的值用红色标出。由于示例程序比较简单，meta1中的几个关键值(pgid,txid,rootBucket)实际上都是db在初始化后赋予的默认值，没有被更改。</p>
<p>可以看到，meta页除了包括db的基础元信息如版本号、页大小等，还包括重要的根节点、事务id等信息。</p>
<p><img src="/images/boltdb/meta1.png" alt="meta1"></p>
<figure>meta1原始数据</figure>
<table style="border-collapse:collapse;border-spacing:0" class="tg"><thead><tr><th style="border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal">offset</th><th style="border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal">0</th><th style="border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal">+1</th><th style="border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal">+2</th><th style="border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal">+3</th><th style="border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal">+4</th><th style="border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal">+5</th><th style="border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal">+6</th><th style="border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal">+7</th><th style="border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal">+8</th><th style="border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal">+9</th><th style="border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal">+a</th><th style="border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal">+b</th><th style="border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal">+c</th><th style="border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal">+d</th><th style="border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal">+e</th><th style="border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal">+f</th></tr></thead><tbody><tr><td style="border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal">0x00004000</td><td style="border-color:inherit;border-style:solid;border-width:1px;color:#fe0000;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal" colspan="8">id=1<br><span style="font-weight:400;font-style:normal">页Id</span></td><td style="border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal" colspan="2">flag=0x04<br>页标识<br><br></td><td style="border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal" colspan="2"><span style="font-weight:400;font-style:normal">count=0</span><br>页内元素项</td><td style="border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal" colspan="4"><span style="font-weight:400;font-style:normal">overflow=0</span><br>页溢出，如果数据太大单页放不下，<br>此数值用来标识溢出了多少页</td></tr><tr><td style="border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal">0x00004010</td><td style="border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal" colspan="4">magic=0xed0cdaed</td><td style="border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal" colspan="4">version=0x02</td><td style="border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal" colspan="4">pagesize=0x4000=16384<br><br>页大小，默认取操作系统页大小</td><td style="border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal" colspan="4"><span style="font-weight:400;font-style:normal">flags=0</span></td></tr><tr><td style="border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal">0x00004020</td><td style="border-color:inherit;border-style:solid;border-width:1px;color:#fe0000;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal" colspan="16"><span style="font-weight:400;font-style:normal">rootBucket=0x03</span><br>B+树根节点所在的页Id</td></tr><tr><td style="border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal">0x00004030</td><td style="border-color:inherit;border-style:solid;border-width:1px;color:#fe0000;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal" colspan="8">freelist_id=0x02<br>自由表的页Id，自由表由空闲页Id组成</td><td style="border-color:inherit;border-style:solid;border-width:1px;color:#fe0000;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal" colspan="8">page_id=0x04</td></tr><tr><td style="border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal">0x00004040</td><td style="border-color:inherit;border-style:solid;border-width:1px;color:#fe0000;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal" colspan="8">tx_id=0x01</td><td style="border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal" colspan="8">校验和</td></tr></tbody></table>
<figure>meta1结构化数据</figure>
<h2>freelist</h2>
<h2>leaf</h2>
<h2>rootBucket</h2>
<p>来到0x04页，也就是meta0中rootBucket所在的页面，我们看看在数据量较少的时候，B+树是如何存储的。</p>
<p><img src="/images/boltdb/rootBucket.png" alt="rootBucket"></p>
<figure>rootBucket原始数据</figure>
<table style="border-collapse:collapse;border-spacing:0" class="tg"><thead><tr><th style="border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal">offset</th><th style="border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal">0</th><th style="border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal">+1</th><th style="border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal">+2</th><th style="border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal">+3</th><th style="border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal">+4</th><th style="border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal">+5</th><th style="border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal">+6</th><th style="border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal">+7</th><th style="border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal">+8</th><th style="border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal">+9</th><th style="border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal">+a</th><th style="border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal">+b</th><th style="border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal">+c</th><th style="border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal">+d</th><th style="border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal">+e</th><th style="border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal">+f</th></tr></thead><tbody><tr><td style="border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal">0x00010000</td><td style="border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal" colspan="8"><span style="font-weight:400;font-style:normal">pgid</span>=0x04<br><span style="font-weight:400;font-style:normal">页Id</span></td><td style="border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal" colspan="2">flag=0x02<br>页标识<br></td><td style="border-color:inherit;border-style:solid;border-width:1px;color:#000000;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal" colspan="2"><span style="font-weight:400;font-style:normal">count=0x01</span><br>页内元素项</td><td style="border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal" colspan="4"><span style="font-weight:400;font-style:normal">overflow=0x00</span><br>页溢出，如果数据太大单页放不下，<br>此数值用来标识溢出了多少页</td></tr><tr><td style="border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal">0x00010010</td><td style="border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal" colspan="4"><span style="font-weight:400;font-style:normal">leafPageElement</span><br>flag=0x01</td><td style="border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal" colspan="4"><span style="font-weight:400;font-style:normal">leafPageElement</span><br>pos=0x10</td><td style="border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal" colspan="4"><span style="font-weight:400;font-style:normal">leafPageElement</span><br>keySize=0x08</td><td style="border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal" colspan="4"><span style="font-weight:400;font-style:normal">leafPageElement</span><br>valSize=0x56</td></tr><tr><td style="border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal">0x00010020</td><td style="border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal" colspan="8">"MyBucket"<br><br>bucket的key</td><td style="border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal" colspan="8">bucket.root=0x00<br>与bucket.sequence一同构成bucket的val</td></tr><tr><td style="border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal">0x00010030</td><td style="border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal" colspan="8"><span style="font-weight:400;font-style:normal">bucket.sequence=</span>0x00</td><td style="border-color:inherit;border-style:solid;border-width:1px;color:#fe0000;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal" colspan="8">0x00<br>虚拟页page id</td></tr><tr><td style="border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal"><span style="font-weight:400;font-style:normal">0x00010030</span></td><td style="border-color:inherit;border-style:solid;border-width:1px;color:#fe0000;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal" colspan="2">0x02<br>虚拟页标识</td><td style="border-color:inherit;border-style:solid;border-width:1px;color:#fe0000;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal" colspan="2">0x20<br>count<br>虚拟页元素数量</td><td style="border-color:inherit;border-style:solid;border-width:1px;color:#fe0000;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal" colspan="4">0x00<br>overflow</td><td style="border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal" colspan="4">leafPageElement<br>flag=0x00</td><td style="border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal" colspan="4">leafPageElement<br>pos=0x20</td></tr><tr><td style="border-color:black;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:left;vertical-align:top;word-break:normal"><span style="font-weight:400;font-style:normal">0x00010040</span></td><td style="border-color:black;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal" colspan="4">leafPageElement<br>keySize=0x05<br>key是name1</td><td style="border-color:black;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal" colspan="4">leafPageElement<br>valSize=0x06<br>val是nicky1</td><td style="border-color:black;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal" colspan="4">leafPageElement<br>flag=0x00</td><td style="border-color:black;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal" colspan="4">leafPageElement<br>pos=0x1b</td></tr><tr><td style="border-color:black;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal"><span style="font-weight:400;font-style:normal">0x00010050</span></td><td style="border-color:black;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal" colspan="4">leafPageElement<br>keySize=0x05<br>key是name2</td><td style="border-color:black;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal" colspan="4">leafPageElement<br>valSize=0x06<br>val是nicky2</td><td style="border-color:black;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal" colspan="8">后面是真实的key,value</td></tr></tbody></table>
<figure>rootBucket结构化数据</figure>
<p>rootBucket存储在一个leafPage中，目前包括一个元素，这个元素是一个类型为bucket的leafPageElement，即概览图中的bucketElm。</p>
<p>为什么bucketElm的val是0x56=86个字节呢？首先bucketElm与一般leafPageElement不同，value是一个结构体，在代码中表示为小写的bucket struct，包括一个8字节的root和一个8字节的序列号。
而一般leafPageElement的value是用户写入的value。</p>
<p>其次由于我们的kv少，符合bucket内联(inline page)的条件，root值为0。用户数据被作为一个虚拟页直接拼在了当前页的后面，这个页的大小也会被统计到value里面。</p>
<pre><code class="hljs language-go"><span class="hljs-comment">// Bucket represents a collection of key/value pairs inside the database.</span>
<span class="hljs-keyword">type</span> Bucket <span class="hljs-keyword">struct</span> {
	*bucket
	tx       *Tx                <span class="hljs-comment">// the associated transaction</span>
	buckets  <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]*Bucket <span class="hljs-comment">// subbucket cache</span>
	page     *page              <span class="hljs-comment">// inline page reference</span>
	rootNode *node              <span class="hljs-comment">// materialized node for the root page.</span>
	nodes    <span class="hljs-keyword">map</span>[pgid]*node     <span class="hljs-comment">// node cache</span>

	<span class="hljs-comment">// Sets the threshold for filling nodes when they split. By default,</span>
	<span class="hljs-comment">// the bucket will fill to 50% but it can be useful to increase this</span>
	<span class="hljs-comment">// amount if you know that your write workloads are mostly append-only.</span>
	<span class="hljs-comment">//</span>
	<span class="hljs-comment">// This is non-persisted across transactions so it must be set in every Tx.</span>
	FillPercent <span class="hljs-type">float64</span>
}


<span class="hljs-comment">// bucket represents the on-file representation of a bucket.</span>
<span class="hljs-comment">// This is stored as the &quot;value&quot; of a bucket key. If the bucket is small enough,</span>
<span class="hljs-comment">// then its root page can be stored inline in the &quot;value&quot;, after the bucket</span>
<span class="hljs-comment">// header. In the case of inline buckets, the &quot;root&quot; will be 0.</span>
<span class="hljs-keyword">type</span> bucket <span class="hljs-keyword">struct</span> {
	root     pgid   <span class="hljs-comment">// page id of the bucket&#x27;s root-level page</span>
	sequence <span class="hljs-type">uint64</span> <span class="hljs-comment">// monotonically incrementing, used by NextSequence()</span>
}
</code></pre>
<figure>bucket struct</figure>
<p>有了这些基础，我们分析下val的总长度：</p>
<pre><code class="hljs"><span class="hljs-function"><span class="hljs-title">len</span>(<span class="hljs-variable">value</span>)  = <span class="hljs-title">len</span>(<span class="hljs-variable">bucket</span> <span class="hljs-variable">struct</span>) + <span class="hljs-title">len</span>(虚拟页)</span>
		= <span class="hljs-number">8</span>(<span class="hljs-variable">root</span>) + <span class="hljs-number">8</span>(<span class="hljs-variable">sequence</span>) + <span class="hljs-function"><span class="hljs-title">len</span>(两个<span class="hljs-variable">kv</span>的<span class="hljs-variable">leafPage</span>)    
		= <span class="hljs-number">8</span> + <span class="hljs-number">8</span> + <span class="hljs-title">len</span>(<span class="hljs-variable">PH</span>) + <span class="hljs-number">2</span> * <span class="hljs-title">len</span>(<span class="hljs-variable">leafPageElement</span>) + <span class="hljs-title">len</span>(<span class="hljs-string">&#x27;name1&#x27;</span> + <span class="hljs-string">&#x27;nicky1&#x27;</span> + <span class="hljs-string">&#x27;name2&#x27;</span> + <span class="hljs-string">&#x27;nicky2&#x27;</span>)</span>
		= <span class="hljs-number">8</span> + <span class="hljs-number">8</span> + <span class="hljs-number">16</span> + <span class="hljs-number">2</span>*<span class="hljs-number">16</span> + <span class="hljs-number">22</span> = <span class="hljs-number">86</span>
</code></pre>
<h2>总结</h2>
<p>到这里Boltdb的几种核心数据结构及其二进制结构都分析完毕，后面我们看Boltdb的源码，是如何基于这些数据结构实现事务和MVCC等特性。</p>
</div></article></main><div class="layout_backToHome__D9QFr"><a href="/">← Back</a></div></div></div><script id="__NEXT_DATA__" type="application/json" crossorigin="">{"props":{"pageProps":{"postData":{"id":"boltdb","contentHtml":"\u003ch2\u003e概览\u003c/h2\u003e\n\u003cp\u003e本文结合Boltdb的\u003ca href=\"https://jaydenwen123.github.io/boltdb/chapter1/boltdb%E7%9A%84%E6%95%B4%E4%BD%93%E6%95%B0%E6%8D%AE%E7%BB%84%E7%BB%87%E7%BB%93%E6%9E%84.html\"\u003e数据结构预览\u003c/a\u003e分析Boltdb的二进制存储文件格式。\n\u003cimg src=\"/images/boltdb/boltdb.png\" alt=\"boltdb\"\u003e\u003c/p\u003e\n\u003cp\u003e示例程序创建一个db，创建MyBucket并写入两个kv，生成my.db文件后用\u003ca href=\"https://iamkate.com/code/binary-file-viewer/\"\u003e二进制文件预览\u003c/a\u003e打开进行分析。\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-go\"\u003e\u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-keyword\"\u003efunc\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003eTestMy\u003c/span\u003e\u003cspan class=\"hljs-params\"\u003e(t *testing.T)\u003c/span\u003e\u003c/span\u003e {\n\t\u003cspan class=\"hljs-comment\"\u003e// Open the my.db data file in your current directory.\u003c/span\u003e\n\t\u003cspan class=\"hljs-comment\"\u003e// It will be created if it doesn\u0026#x27;t exist.\u003c/span\u003e\n\tdb, err := bolt.Open(\u003cspan class=\"hljs-string\"\u003e\u0026quot;my.db\u0026quot;\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e0600\u003c/span\u003e, \u003cspan class=\"hljs-literal\"\u003enil\u003c/span\u003e)\n\t\u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e err != \u003cspan class=\"hljs-literal\"\u003enil\u003c/span\u003e {\n\t\tlog.Fatal(err)\n\t}\n\t\u003cspan class=\"hljs-keyword\"\u003edefer\u003c/span\u003e db.Close()\n\n\terr = db.Update(\u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-keyword\"\u003efunc\u003c/span\u003e\u003cspan class=\"hljs-params\"\u003e(tx *bolt.Tx)\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"hljs-type\"\u003eerror\u003c/span\u003e {\n\t\tb, err := tx.CreateBucketIfNotExists([]\u003cspan class=\"hljs-type\"\u003ebyte\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;MyBucket\u0026quot;\u003c/span\u003e))\n\t\t\u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e err != \u003cspan class=\"hljs-literal\"\u003enil\u003c/span\u003e {\n\t\t\t\u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e fmt.Errorf(\u003cspan class=\"hljs-string\"\u003e\u0026quot;create bucket: %s\u0026quot;\u003c/span\u003e, err)\n\t\t}\n\n\t\terr = b.Put([]\u003cspan class=\"hljs-type\"\u003ebyte\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;name1\u0026quot;\u003c/span\u003e), []\u003cspan class=\"hljs-type\"\u003ebyte\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;nicky1\u0026quot;\u003c/span\u003e))\n\t\t\u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e err != \u003cspan class=\"hljs-literal\"\u003enil\u003c/span\u003e {\n\t\t\t\u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e err\n\t\t}\n\n\t\terr = b.Put([]\u003cspan class=\"hljs-type\"\u003ebyte\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;name2\u0026quot;\u003c/span\u003e), []\u003cspan class=\"hljs-type\"\u003ebyte\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;nicky2\u0026quot;\u003c/span\u003e))\n\t\t\u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e err != \u003cspan class=\"hljs-literal\"\u003enil\u003c/span\u003e {\n\t\t\t\u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e err\n\t\t}\n\n\t\t\u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-literal\"\u003enil\u003c/span\u003e\n\t})\n\t\u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e err != \u003cspan class=\"hljs-literal\"\u003enil\u003c/span\u003e {\n\t\tlog.Fatal(err)\n\t}\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2\u003epage\u003c/h2\u003e\n\u003cp\u003epage(页)是Boltdb存储的基本单位，由一块固定大小的存储区域组成。我的操作系统默认页大小为16384(16K)即0x4000，因此0x0000~0x4000为第0页，0x4000~0x8000为第1页，以此类推。\u003c/p\u003e\n\u003cp\u003eBoltdb的页包括页头和一个任意大小的指针ptr。页头中标识了页类型、元素数量、溢出大小等信息，ptr用来指向页头的结束地址，或者说是页内容的开始地址，这样代码中可以用ptr跳过页头直接获取页面的内容。\u003c/p\u003e\n\u003cp\u003e值得注意的是除了物理的、实际存在的page，boltdb还会构造虚拟页来辅助存储，这些虚拟页并没有真实的页Id，在后续的bucket中会看到。\u003c/p\u003e\n\u003ch2\u003emeta\u003c/h2\u003e\n\u003cp\u003e第0x00，0x01页是meta页，负责存储meta信息，为什么有两个meta页我们在分析完Boltdb事务后会了解。\u003c/p\u003e\n\u003cp\u003emeta0存储了rootBucket的值。Boltdb的数据存储是一颗B+树，rootBucket指向这颗B+树的根节点所在的页id，示例中就是id为0x04的page。\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/images/boltdb/meta0.png\" alt=\"meta0\"\u003e\u003c/p\u003e\n\u003cfigure\u003emeta0原始数据\u003c/figure\u003e\n\u003ctable style=\"border-collapse:collapse;border-spacing:0\" class=\"tg\"\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd style=\"border-color:black;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\"\u003eoffset\u003c/td\u003e\u003ctd style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\"\u003e0\u003c/td\u003e\u003ctd style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\"\u003e+1\u003c/td\u003e\u003ctd style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\"\u003e+2\u003c/td\u003e\u003ctd style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\"\u003e+3\u003c/td\u003e\u003ctd style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\"\u003e+4\u003c/td\u003e\u003ctd style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\"\u003e+5\u003c/td\u003e\u003ctd style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\"\u003e+6\u003c/td\u003e\u003ctd style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\"\u003e+7\u003c/td\u003e\u003ctd style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\"\u003e+8\u003c/td\u003e\u003ctd style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\"\u003e+9\u003c/td\u003e\u003ctd style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\"\u003e+a\u003c/td\u003e\u003ctd style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\"\u003e+b\u003c/td\u003e\u003ctd style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\"\u003e+c\u003c/td\u003e\u003ctd style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\"\u003e+d\u003c/td\u003e\u003ctd style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\"\u003e+e\u003c/td\u003e\u003ctd style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\"\u003e+f\u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd style=\"border-color:black;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\"\u003e0x00000000\u003c/td\u003e\u003ctd style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"8\"\u003eid=0\u003cbr\u003e\u003cspan style=\"font-weight:400;font-style:normal\"\u003e页Id\u003c/span\u003e\u003c/td\u003e\u003ctd style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"2\"\u003eflag=0x04\u003cbr\u003e页标识\u003cbr\u003e\u003cbr\u003e\u003c/td\u003e\u003ctd style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"2\"\u003e\u003cspan style=\"font-weight:400;font-style:normal\"\u003ecount=0\u003c/span\u003e\u003cbr\u003e页内元素项\u003c/td\u003e\u003ctd style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"4\"\u003e\u003cspan style=\"font-weight:400;font-style:normal\"\u003eoverflow=0\u003c/span\u003e\u003cbr\u003e页溢出，如果数据太大单页放不下，\u003cbr\u003e此数值用来标识溢出了多少页\u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd style=\"border-color:black;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\"\u003e0x00000010\u003c/td\u003e\u003ctd style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"4\"\u003emagic=0xed0cdaed\u003c/td\u003e\u003ctd style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"4\"\u003eversion=0x02\u003c/td\u003e\u003ctd style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"4\"\u003epagesize=0x4000=16384\u003cbr\u003e\u003cbr\u003e页大小，默认取操作系统页大小\u003c/td\u003e\u003ctd style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"4\"\u003e\u003cspan style=\"font-weight:400;font-style:normal\"\u003eflags=0\u003c/span\u003e\u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd style=\"border-color:black;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\"\u003e0x00000020\u003c/td\u003e\u003ctd style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"16\"\u003e\u003cspan style=\"font-weight:400;font-style:normal;color:#FE0000\"\u003erootBucket=0x04\u003c/span\u003e\u003cbr\u003e\u003cspan style=\"color:#FE0000\"\u003eB+树根节点所在的页Id\u003c/span\u003e\u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd style=\"border-color:black;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\"\u003e0x00000030\u003c/td\u003e\u003ctd style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"8\"\u003efreelist_id=0x05\u003cbr\u003e自由表的页Id，自由表由空闲页Id组成\u003c/td\u003e\u003ctd style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"8\"\u003epage_id=0x06\u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd style=\"border-color:black;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\"\u003e0x00000040\u003c/td\u003e\u003ctd style=\"border-color:black;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"8\"\u003etx_id=0x02\u003c/td\u003e\u003ctd style=\"border-color:black;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"8\"\u003e校验和\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\n\u003cfigure\u003emeta0结构化数据\u003c/figure\u003e\n\u003cp\u003emeta1与meta0不同的值用红色标出。由于示例程序比较简单，meta1中的几个关键值(pgid,txid,rootBucket)实际上都是db在初始化后赋予的默认值，没有被更改。\u003c/p\u003e\n\u003cp\u003e可以看到，meta页除了包括db的基础元信息如版本号、页大小等，还包括重要的根节点、事务id等信息。\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/images/boltdb/meta1.png\" alt=\"meta1\"\u003e\u003c/p\u003e\n\u003cfigure\u003emeta1原始数据\u003c/figure\u003e\n\u003ctable style=\"border-collapse:collapse;border-spacing:0\" class=\"tg\"\u003e\u003cthead\u003e\u003ctr\u003e\u003cth style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\"\u003eoffset\u003c/th\u003e\u003cth style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\"\u003e0\u003c/th\u003e\u003cth style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\"\u003e+1\u003c/th\u003e\u003cth style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\"\u003e+2\u003c/th\u003e\u003cth style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\"\u003e+3\u003c/th\u003e\u003cth style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\"\u003e+4\u003c/th\u003e\u003cth style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\"\u003e+5\u003c/th\u003e\u003cth style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\"\u003e+6\u003c/th\u003e\u003cth style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\"\u003e+7\u003c/th\u003e\u003cth style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\"\u003e+8\u003c/th\u003e\u003cth style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\"\u003e+9\u003c/th\u003e\u003cth style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\"\u003e+a\u003c/th\u003e\u003cth style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\"\u003e+b\u003c/th\u003e\u003cth style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\"\u003e+c\u003c/th\u003e\u003cth style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\"\u003e+d\u003c/th\u003e\u003cth style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\"\u003e+e\u003c/th\u003e\u003cth style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\"\u003e+f\u003c/th\u003e\u003c/tr\u003e\u003c/thead\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\"\u003e0x00004000\u003c/td\u003e\u003ctd style=\"border-color:inherit;border-style:solid;border-width:1px;color:#fe0000;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"8\"\u003eid=1\u003cbr\u003e\u003cspan style=\"font-weight:400;font-style:normal\"\u003e页Id\u003c/span\u003e\u003c/td\u003e\u003ctd style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"2\"\u003eflag=0x04\u003cbr\u003e页标识\u003cbr\u003e\u003cbr\u003e\u003c/td\u003e\u003ctd style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"2\"\u003e\u003cspan style=\"font-weight:400;font-style:normal\"\u003ecount=0\u003c/span\u003e\u003cbr\u003e页内元素项\u003c/td\u003e\u003ctd style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"4\"\u003e\u003cspan style=\"font-weight:400;font-style:normal\"\u003eoverflow=0\u003c/span\u003e\u003cbr\u003e页溢出，如果数据太大单页放不下，\u003cbr\u003e此数值用来标识溢出了多少页\u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\"\u003e0x00004010\u003c/td\u003e\u003ctd style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"4\"\u003emagic=0xed0cdaed\u003c/td\u003e\u003ctd style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"4\"\u003eversion=0x02\u003c/td\u003e\u003ctd style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"4\"\u003epagesize=0x4000=16384\u003cbr\u003e\u003cbr\u003e页大小，默认取操作系统页大小\u003c/td\u003e\u003ctd style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"4\"\u003e\u003cspan style=\"font-weight:400;font-style:normal\"\u003eflags=0\u003c/span\u003e\u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\"\u003e0x00004020\u003c/td\u003e\u003ctd style=\"border-color:inherit;border-style:solid;border-width:1px;color:#fe0000;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"16\"\u003e\u003cspan style=\"font-weight:400;font-style:normal\"\u003erootBucket=0x03\u003c/span\u003e\u003cbr\u003eB+树根节点所在的页Id\u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\"\u003e0x00004030\u003c/td\u003e\u003ctd style=\"border-color:inherit;border-style:solid;border-width:1px;color:#fe0000;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"8\"\u003efreelist_id=0x02\u003cbr\u003e自由表的页Id，自由表由空闲页Id组成\u003c/td\u003e\u003ctd style=\"border-color:inherit;border-style:solid;border-width:1px;color:#fe0000;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"8\"\u003epage_id=0x04\u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\"\u003e0x00004040\u003c/td\u003e\u003ctd style=\"border-color:inherit;border-style:solid;border-width:1px;color:#fe0000;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"8\"\u003etx_id=0x01\u003c/td\u003e\u003ctd style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"8\"\u003e校验和\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\n\u003cfigure\u003emeta1结构化数据\u003c/figure\u003e\n\u003ch2\u003efreelist\u003c/h2\u003e\n\u003ch2\u003eleaf\u003c/h2\u003e\n\u003ch2\u003erootBucket\u003c/h2\u003e\n\u003cp\u003e来到0x04页，也就是meta0中rootBucket所在的页面，我们看看在数据量较少的时候，B+树是如何存储的。\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/images/boltdb/rootBucket.png\" alt=\"rootBucket\"\u003e\u003c/p\u003e\n\u003cfigure\u003erootBucket原始数据\u003c/figure\u003e\n\u003ctable style=\"border-collapse:collapse;border-spacing:0\" class=\"tg\"\u003e\u003cthead\u003e\u003ctr\u003e\u003cth style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\"\u003eoffset\u003c/th\u003e\u003cth style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\"\u003e0\u003c/th\u003e\u003cth style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\"\u003e+1\u003c/th\u003e\u003cth style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\"\u003e+2\u003c/th\u003e\u003cth style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\"\u003e+3\u003c/th\u003e\u003cth style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\"\u003e+4\u003c/th\u003e\u003cth style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\"\u003e+5\u003c/th\u003e\u003cth style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\"\u003e+6\u003c/th\u003e\u003cth style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\"\u003e+7\u003c/th\u003e\u003cth style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\"\u003e+8\u003c/th\u003e\u003cth style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\"\u003e+9\u003c/th\u003e\u003cth style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\"\u003e+a\u003c/th\u003e\u003cth style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\"\u003e+b\u003c/th\u003e\u003cth style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\"\u003e+c\u003c/th\u003e\u003cth style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\"\u003e+d\u003c/th\u003e\u003cth style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\"\u003e+e\u003c/th\u003e\u003cth style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\"\u003e+f\u003c/th\u003e\u003c/tr\u003e\u003c/thead\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\"\u003e0x00010000\u003c/td\u003e\u003ctd style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"8\"\u003e\u003cspan style=\"font-weight:400;font-style:normal\"\u003epgid\u003c/span\u003e=0x04\u003cbr\u003e\u003cspan style=\"font-weight:400;font-style:normal\"\u003e页Id\u003c/span\u003e\u003c/td\u003e\u003ctd style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"2\"\u003eflag=0x02\u003cbr\u003e页标识\u003cbr\u003e\u003c/td\u003e\u003ctd style=\"border-color:inherit;border-style:solid;border-width:1px;color:#000000;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"2\"\u003e\u003cspan style=\"font-weight:400;font-style:normal\"\u003ecount=0x01\u003c/span\u003e\u003cbr\u003e页内元素项\u003c/td\u003e\u003ctd style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"4\"\u003e\u003cspan style=\"font-weight:400;font-style:normal\"\u003eoverflow=0x00\u003c/span\u003e\u003cbr\u003e页溢出，如果数据太大单页放不下，\u003cbr\u003e此数值用来标识溢出了多少页\u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\"\u003e0x00010010\u003c/td\u003e\u003ctd style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"4\"\u003e\u003cspan style=\"font-weight:400;font-style:normal\"\u003eleafPageElement\u003c/span\u003e\u003cbr\u003eflag=0x01\u003c/td\u003e\u003ctd style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"4\"\u003e\u003cspan style=\"font-weight:400;font-style:normal\"\u003eleafPageElement\u003c/span\u003e\u003cbr\u003epos=0x10\u003c/td\u003e\u003ctd style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"4\"\u003e\u003cspan style=\"font-weight:400;font-style:normal\"\u003eleafPageElement\u003c/span\u003e\u003cbr\u003ekeySize=0x08\u003c/td\u003e\u003ctd style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"4\"\u003e\u003cspan style=\"font-weight:400;font-style:normal\"\u003eleafPageElement\u003c/span\u003e\u003cbr\u003evalSize=0x56\u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\"\u003e0x00010020\u003c/td\u003e\u003ctd style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"8\"\u003e\"MyBucket\"\u003cbr\u003e\u003cbr\u003ebucket的key\u003c/td\u003e\u003ctd style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"8\"\u003ebucket.root=0x00\u003cbr\u003e与bucket.sequence一同构成bucket的val\u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\"\u003e0x00010030\u003c/td\u003e\u003ctd style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"8\"\u003e\u003cspan style=\"font-weight:400;font-style:normal\"\u003ebucket.sequence=\u003c/span\u003e0x00\u003c/td\u003e\u003ctd style=\"border-color:inherit;border-style:solid;border-width:1px;color:#fe0000;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"8\"\u003e0x00\u003cbr\u003e虚拟页page id\u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\"\u003e\u003cspan style=\"font-weight:400;font-style:normal\"\u003e0x00010030\u003c/span\u003e\u003c/td\u003e\u003ctd style=\"border-color:inherit;border-style:solid;border-width:1px;color:#fe0000;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"2\"\u003e0x02\u003cbr\u003e虚拟页标识\u003c/td\u003e\u003ctd style=\"border-color:inherit;border-style:solid;border-width:1px;color:#fe0000;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"2\"\u003e0x20\u003cbr\u003ecount\u003cbr\u003e虚拟页元素数量\u003c/td\u003e\u003ctd style=\"border-color:inherit;border-style:solid;border-width:1px;color:#fe0000;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"4\"\u003e0x00\u003cbr\u003eoverflow\u003c/td\u003e\u003ctd style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"4\"\u003eleafPageElement\u003cbr\u003eflag=0x00\u003c/td\u003e\u003ctd style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"4\"\u003eleafPageElement\u003cbr\u003epos=0x20\u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd style=\"border-color:black;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:left;vertical-align:top;word-break:normal\"\u003e\u003cspan style=\"font-weight:400;font-style:normal\"\u003e0x00010040\u003c/span\u003e\u003c/td\u003e\u003ctd style=\"border-color:black;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"4\"\u003eleafPageElement\u003cbr\u003ekeySize=0x05\u003cbr\u003ekey是name1\u003c/td\u003e\u003ctd style=\"border-color:black;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"4\"\u003eleafPageElement\u003cbr\u003evalSize=0x06\u003cbr\u003eval是nicky1\u003c/td\u003e\u003ctd style=\"border-color:black;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"4\"\u003eleafPageElement\u003cbr\u003eflag=0x00\u003c/td\u003e\u003ctd style=\"border-color:black;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"4\"\u003eleafPageElement\u003cbr\u003epos=0x1b\u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd style=\"border-color:black;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\"\u003e\u003cspan style=\"font-weight:400;font-style:normal\"\u003e0x00010050\u003c/span\u003e\u003c/td\u003e\u003ctd style=\"border-color:black;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"4\"\u003eleafPageElement\u003cbr\u003ekeySize=0x05\u003cbr\u003ekey是name2\u003c/td\u003e\u003ctd style=\"border-color:black;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"4\"\u003eleafPageElement\u003cbr\u003evalSize=0x06\u003cbr\u003eval是nicky2\u003c/td\u003e\u003ctd style=\"border-color:black;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"8\"\u003e后面是真实的key,value\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\n\u003cfigure\u003erootBucket结构化数据\u003c/figure\u003e\n\u003cp\u003erootBucket存储在一个leafPage中，目前包括一个元素，这个元素是一个类型为bucket的leafPageElement，即概览图中的bucketElm。\u003c/p\u003e\n\u003cp\u003e为什么bucketElm的val是0x56=86个字节呢？首先bucketElm与一般leafPageElement不同，value是一个结构体，在代码中表示为小写的bucket struct，包括一个8字节的root和一个8字节的序列号。\n而一般leafPageElement的value是用户写入的value。\u003c/p\u003e\n\u003cp\u003e其次由于我们的kv少，符合bucket内联(inline page)的条件，root值为0。用户数据被作为一个虚拟页直接拼在了当前页的后面，这个页的大小也会被统计到value里面。\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-go\"\u003e\u003cspan class=\"hljs-comment\"\u003e// Bucket represents a collection of key/value pairs inside the database.\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003etype\u003c/span\u003e Bucket \u003cspan class=\"hljs-keyword\"\u003estruct\u003c/span\u003e {\n\t*bucket\n\ttx       *Tx                \u003cspan class=\"hljs-comment\"\u003e// the associated transaction\u003c/span\u003e\n\tbuckets  \u003cspan class=\"hljs-keyword\"\u003emap\u003c/span\u003e[\u003cspan class=\"hljs-type\"\u003estring\u003c/span\u003e]*Bucket \u003cspan class=\"hljs-comment\"\u003e// subbucket cache\u003c/span\u003e\n\tpage     *page              \u003cspan class=\"hljs-comment\"\u003e// inline page reference\u003c/span\u003e\n\trootNode *node              \u003cspan class=\"hljs-comment\"\u003e// materialized node for the root page.\u003c/span\u003e\n\tnodes    \u003cspan class=\"hljs-keyword\"\u003emap\u003c/span\u003e[pgid]*node     \u003cspan class=\"hljs-comment\"\u003e// node cache\u003c/span\u003e\n\n\t\u003cspan class=\"hljs-comment\"\u003e// Sets the threshold for filling nodes when they split. By default,\u003c/span\u003e\n\t\u003cspan class=\"hljs-comment\"\u003e// the bucket will fill to 50% but it can be useful to increase this\u003c/span\u003e\n\t\u003cspan class=\"hljs-comment\"\u003e// amount if you know that your write workloads are mostly append-only.\u003c/span\u003e\n\t\u003cspan class=\"hljs-comment\"\u003e//\u003c/span\u003e\n\t\u003cspan class=\"hljs-comment\"\u003e// This is non-persisted across transactions so it must be set in every Tx.\u003c/span\u003e\n\tFillPercent \u003cspan class=\"hljs-type\"\u003efloat64\u003c/span\u003e\n}\n\n\n\u003cspan class=\"hljs-comment\"\u003e// bucket represents the on-file representation of a bucket.\u003c/span\u003e\n\u003cspan class=\"hljs-comment\"\u003e// This is stored as the \u0026quot;value\u0026quot; of a bucket key. If the bucket is small enough,\u003c/span\u003e\n\u003cspan class=\"hljs-comment\"\u003e// then its root page can be stored inline in the \u0026quot;value\u0026quot;, after the bucket\u003c/span\u003e\n\u003cspan class=\"hljs-comment\"\u003e// header. In the case of inline buckets, the \u0026quot;root\u0026quot; will be 0.\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003etype\u003c/span\u003e bucket \u003cspan class=\"hljs-keyword\"\u003estruct\u003c/span\u003e {\n\troot     pgid   \u003cspan class=\"hljs-comment\"\u003e// page id of the bucket\u0026#x27;s root-level page\u003c/span\u003e\n\tsequence \u003cspan class=\"hljs-type\"\u003euint64\u003c/span\u003e \u003cspan class=\"hljs-comment\"\u003e// monotonically incrementing, used by NextSequence()\u003c/span\u003e\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cfigure\u003ebucket struct\u003c/figure\u003e\n\u003cp\u003e有了这些基础，我们分析下val的总长度：\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs\"\u003e\u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-title\"\u003elen\u003c/span\u003e(\u003cspan class=\"hljs-variable\"\u003evalue\u003c/span\u003e)  = \u003cspan class=\"hljs-title\"\u003elen\u003c/span\u003e(\u003cspan class=\"hljs-variable\"\u003ebucket\u003c/span\u003e \u003cspan class=\"hljs-variable\"\u003estruct\u003c/span\u003e) + \u003cspan class=\"hljs-title\"\u003elen\u003c/span\u003e(虚拟页)\u003c/span\u003e\n\t\t= \u003cspan class=\"hljs-number\"\u003e8\u003c/span\u003e(\u003cspan class=\"hljs-variable\"\u003eroot\u003c/span\u003e) + \u003cspan class=\"hljs-number\"\u003e8\u003c/span\u003e(\u003cspan class=\"hljs-variable\"\u003esequence\u003c/span\u003e) + \u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-title\"\u003elen\u003c/span\u003e(两个\u003cspan class=\"hljs-variable\"\u003ekv\u003c/span\u003e的\u003cspan class=\"hljs-variable\"\u003eleafPage\u003c/span\u003e)    \n\t\t= \u003cspan class=\"hljs-number\"\u003e8\u003c/span\u003e + \u003cspan class=\"hljs-number\"\u003e8\u003c/span\u003e + \u003cspan class=\"hljs-title\"\u003elen\u003c/span\u003e(\u003cspan class=\"hljs-variable\"\u003ePH\u003c/span\u003e) + \u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e * \u003cspan class=\"hljs-title\"\u003elen\u003c/span\u003e(\u003cspan class=\"hljs-variable\"\u003eleafPageElement\u003c/span\u003e) + \u003cspan class=\"hljs-title\"\u003elen\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026#x27;name1\u0026#x27;\u003c/span\u003e + \u003cspan class=\"hljs-string\"\u003e\u0026#x27;nicky1\u0026#x27;\u003c/span\u003e + \u003cspan class=\"hljs-string\"\u003e\u0026#x27;name2\u0026#x27;\u003c/span\u003e + \u003cspan class=\"hljs-string\"\u003e\u0026#x27;nicky2\u0026#x27;\u003c/span\u003e)\u003c/span\u003e\n\t\t= \u003cspan class=\"hljs-number\"\u003e8\u003c/span\u003e + \u003cspan class=\"hljs-number\"\u003e8\u003c/span\u003e + \u003cspan class=\"hljs-number\"\u003e16\u003c/span\u003e + \u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e*\u003cspan class=\"hljs-number\"\u003e16\u003c/span\u003e + \u003cspan class=\"hljs-number\"\u003e22\u003c/span\u003e = \u003cspan class=\"hljs-number\"\u003e86\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2\u003e总结\u003c/h2\u003e\n\u003cp\u003e到这里Boltdb的几种核心数据结构及其二进制结构都分析完毕，后面我们看Boltdb的源码，是如何基于这些数据结构实现事务和MVCC等特性。\u003c/p\u003e\n","title":"Boltdb数据结构-二进制存储","date":"2023-12-26","description":"对照二进制存储文件分析Boltdb的数据结构"}},"__N_SSG":true},"page":"/posts/[id]","query":{"id":"boltdb"},"buildId":"tBDcWIf9tU2_6gXjzKBx-","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>