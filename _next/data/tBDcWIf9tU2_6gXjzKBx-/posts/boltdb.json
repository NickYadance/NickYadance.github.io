{"pageProps":{"postData":{"id":"boltdb","contentHtml":"<h2>概览</h2>\n<p>本文结合Boltdb的<a href=\"https://jaydenwen123.github.io/boltdb/chapter1/boltdb%E7%9A%84%E6%95%B4%E4%BD%93%E6%95%B0%E6%8D%AE%E7%BB%84%E7%BB%87%E7%BB%93%E6%9E%84.html\">数据结构预览</a>分析Boltdb的二进制存储文件格式。\n<img src=\"/images/boltdb/boltdb.png\" alt=\"boltdb\"></p>\n<p>示例程序创建一个db，创建MyBucket并写入两个kv，生成my.db文件后用<a href=\"https://iamkate.com/code/binary-file-viewer/\">二进制文件预览</a>打开进行分析。</p>\n<pre><code class=\"hljs language-go\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-title\">TestMy</span><span class=\"hljs-params\">(t *testing.T)</span></span> {\n\t<span class=\"hljs-comment\">// Open the my.db data file in your current directory.</span>\n\t<span class=\"hljs-comment\">// It will be created if it doesn&#x27;t exist.</span>\n\tdb, err := bolt.Open(<span class=\"hljs-string\">&quot;my.db&quot;</span>, <span class=\"hljs-number\">0600</span>, <span class=\"hljs-literal\">nil</span>)\n\t<span class=\"hljs-keyword\">if</span> err != <span class=\"hljs-literal\">nil</span> {\n\t\tlog.Fatal(err)\n\t}\n\t<span class=\"hljs-keyword\">defer</span> db.Close()\n\n\terr = db.Update(<span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span><span class=\"hljs-params\">(tx *bolt.Tx)</span></span> <span class=\"hljs-type\">error</span> {\n\t\tb, err := tx.CreateBucketIfNotExists([]<span class=\"hljs-type\">byte</span>(<span class=\"hljs-string\">&quot;MyBucket&quot;</span>))\n\t\t<span class=\"hljs-keyword\">if</span> err != <span class=\"hljs-literal\">nil</span> {\n\t\t\t<span class=\"hljs-keyword\">return</span> fmt.Errorf(<span class=\"hljs-string\">&quot;create bucket: %s&quot;</span>, err)\n\t\t}\n\n\t\terr = b.Put([]<span class=\"hljs-type\">byte</span>(<span class=\"hljs-string\">&quot;name1&quot;</span>), []<span class=\"hljs-type\">byte</span>(<span class=\"hljs-string\">&quot;nicky1&quot;</span>))\n\t\t<span class=\"hljs-keyword\">if</span> err != <span class=\"hljs-literal\">nil</span> {\n\t\t\t<span class=\"hljs-keyword\">return</span> err\n\t\t}\n\n\t\terr = b.Put([]<span class=\"hljs-type\">byte</span>(<span class=\"hljs-string\">&quot;name2&quot;</span>), []<span class=\"hljs-type\">byte</span>(<span class=\"hljs-string\">&quot;nicky2&quot;</span>))\n\t\t<span class=\"hljs-keyword\">if</span> err != <span class=\"hljs-literal\">nil</span> {\n\t\t\t<span class=\"hljs-keyword\">return</span> err\n\t\t}\n\n\t\t<span class=\"hljs-keyword\">return</span> <span class=\"hljs-literal\">nil</span>\n\t})\n\t<span class=\"hljs-keyword\">if</span> err != <span class=\"hljs-literal\">nil</span> {\n\t\tlog.Fatal(err)\n\t}\n}\n</code></pre>\n<h2>page</h2>\n<p>page(页)是Boltdb存储的基本单位，由一块固定大小的存储区域组成。我的操作系统默认页大小为16384(16K)即0x4000，因此0x0000~0x4000为第0页，0x4000~0x8000为第1页，以此类推。</p>\n<p>Boltdb的页包括页头和一个任意大小的指针ptr。页头中标识了页类型、元素数量、溢出大小等信息，ptr用来指向页头的结束地址，或者说是页内容的开始地址，这样代码中可以用ptr跳过页头直接获取页面的内容。</p>\n<p>值得注意的是除了物理的、实际存在的page，boltdb还会构造虚拟页来辅助存储，这些虚拟页并没有真实的页Id，在后续的bucket中会看到。</p>\n<h2>meta</h2>\n<p>第0x00，0x01页是meta页，负责存储meta信息，为什么有两个meta页我们在分析完Boltdb事务后会了解。</p>\n<p>meta0存储了rootBucket的值。Boltdb的数据存储是一颗B+树，rootBucket指向这颗B+树的根节点所在的页id，示例中就是id为0x04的page。</p>\n<p><img src=\"/images/boltdb/meta0.png\" alt=\"meta0\"></p>\n<figure>meta0原始数据</figure>\n<table style=\"border-collapse:collapse;border-spacing:0\" class=\"tg\"><tbody><tr><td style=\"border-color:black;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\">offset</td><td style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\">0</td><td style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\">+1</td><td style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\">+2</td><td style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\">+3</td><td style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\">+4</td><td style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\">+5</td><td style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\">+6</td><td style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\">+7</td><td style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\">+8</td><td style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\">+9</td><td style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\">+a</td><td style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\">+b</td><td style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\">+c</td><td style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\">+d</td><td style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\">+e</td><td style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\">+f</td></tr><tr><td style=\"border-color:black;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\">0x00000000</td><td style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"8\">id=0<br><span style=\"font-weight:400;font-style:normal\">页Id</span></td><td style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"2\">flag=0x04<br>页标识<br><br></td><td style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"2\"><span style=\"font-weight:400;font-style:normal\">count=0</span><br>页内元素项</td><td style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"4\"><span style=\"font-weight:400;font-style:normal\">overflow=0</span><br>页溢出，如果数据太大单页放不下，<br>此数值用来标识溢出了多少页</td></tr><tr><td style=\"border-color:black;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\">0x00000010</td><td style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"4\">magic=0xed0cdaed</td><td style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"4\">version=0x02</td><td style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"4\">pagesize=0x4000=16384<br><br>页大小，默认取操作系统页大小</td><td style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"4\"><span style=\"font-weight:400;font-style:normal\">flags=0</span></td></tr><tr><td style=\"border-color:black;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\">0x00000020</td><td style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"16\"><span style=\"font-weight:400;font-style:normal;color:#FE0000\">rootBucket=0x04</span><br><span style=\"color:#FE0000\">B+树根节点所在的页Id</span></td></tr><tr><td style=\"border-color:black;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\">0x00000030</td><td style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"8\">freelist_id=0x05<br>自由表的页Id，自由表由空闲页Id组成</td><td style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"8\">page_id=0x06</td></tr><tr><td style=\"border-color:black;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\">0x00000040</td><td style=\"border-color:black;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"8\">tx_id=0x02</td><td style=\"border-color:black;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"8\">校验和</td></tr></tbody></table>\n<figure>meta0结构化数据</figure>\n<p>meta1与meta0不同的值用红色标出。由于示例程序比较简单，meta1中的几个关键值(pgid,txid,rootBucket)实际上都是db在初始化后赋予的默认值，没有被更改。</p>\n<p>可以看到，meta页除了包括db的基础元信息如版本号、页大小等，还包括重要的根节点、事务id等信息。</p>\n<p><img src=\"/images/boltdb/meta1.png\" alt=\"meta1\"></p>\n<figure>meta1原始数据</figure>\n<table style=\"border-collapse:collapse;border-spacing:0\" class=\"tg\"><thead><tr><th style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\">offset</th><th style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\">0</th><th style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\">+1</th><th style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\">+2</th><th style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\">+3</th><th style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\">+4</th><th style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\">+5</th><th style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\">+6</th><th style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\">+7</th><th style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\">+8</th><th style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\">+9</th><th style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\">+a</th><th style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\">+b</th><th style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\">+c</th><th style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\">+d</th><th style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\">+e</th><th style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\">+f</th></tr></thead><tbody><tr><td style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\">0x00004000</td><td style=\"border-color:inherit;border-style:solid;border-width:1px;color:#fe0000;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"8\">id=1<br><span style=\"font-weight:400;font-style:normal\">页Id</span></td><td style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"2\">flag=0x04<br>页标识<br><br></td><td style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"2\"><span style=\"font-weight:400;font-style:normal\">count=0</span><br>页内元素项</td><td style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"4\"><span style=\"font-weight:400;font-style:normal\">overflow=0</span><br>页溢出，如果数据太大单页放不下，<br>此数值用来标识溢出了多少页</td></tr><tr><td style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\">0x00004010</td><td style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"4\">magic=0xed0cdaed</td><td style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"4\">version=0x02</td><td style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"4\">pagesize=0x4000=16384<br><br>页大小，默认取操作系统页大小</td><td style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"4\"><span style=\"font-weight:400;font-style:normal\">flags=0</span></td></tr><tr><td style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\">0x00004020</td><td style=\"border-color:inherit;border-style:solid;border-width:1px;color:#fe0000;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"16\"><span style=\"font-weight:400;font-style:normal\">rootBucket=0x03</span><br>B+树根节点所在的页Id</td></tr><tr><td style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\">0x00004030</td><td style=\"border-color:inherit;border-style:solid;border-width:1px;color:#fe0000;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"8\">freelist_id=0x02<br>自由表的页Id，自由表由空闲页Id组成</td><td style=\"border-color:inherit;border-style:solid;border-width:1px;color:#fe0000;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"8\">page_id=0x04</td></tr><tr><td style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\">0x00004040</td><td style=\"border-color:inherit;border-style:solid;border-width:1px;color:#fe0000;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"8\">tx_id=0x01</td><td style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"8\">校验和</td></tr></tbody></table>\n<figure>meta1结构化数据</figure>\n<h2>freelist</h2>\n<h2>leaf</h2>\n<h2>rootBucket</h2>\n<p>来到0x04页，也就是meta0中rootBucket所在的页面，我们看看在数据量较少的时候，B+树是如何存储的。</p>\n<p><img src=\"/images/boltdb/rootBucket.png\" alt=\"rootBucket\"></p>\n<figure>rootBucket原始数据</figure>\n<table style=\"border-collapse:collapse;border-spacing:0\" class=\"tg\"><thead><tr><th style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\">offset</th><th style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\">0</th><th style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\">+1</th><th style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\">+2</th><th style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\">+3</th><th style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\">+4</th><th style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\">+5</th><th style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\">+6</th><th style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\">+7</th><th style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\">+8</th><th style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\">+9</th><th style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\">+a</th><th style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\">+b</th><th style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\">+c</th><th style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\">+d</th><th style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\">+e</th><th style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\">+f</th></tr></thead><tbody><tr><td style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\">0x00010000</td><td style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"8\"><span style=\"font-weight:400;font-style:normal\">pgid</span>=0x04<br><span style=\"font-weight:400;font-style:normal\">页Id</span></td><td style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"2\">flag=0x02<br>页标识<br></td><td style=\"border-color:inherit;border-style:solid;border-width:1px;color:#000000;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"2\"><span style=\"font-weight:400;font-style:normal\">count=0x01</span><br>页内元素项</td><td style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"4\"><span style=\"font-weight:400;font-style:normal\">overflow=0x00</span><br>页溢出，如果数据太大单页放不下，<br>此数值用来标识溢出了多少页</td></tr><tr><td style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\">0x00010010</td><td style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"4\"><span style=\"font-weight:400;font-style:normal\">leafPageElement</span><br>flag=0x01</td><td style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"4\"><span style=\"font-weight:400;font-style:normal\">leafPageElement</span><br>pos=0x10</td><td style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"4\"><span style=\"font-weight:400;font-style:normal\">leafPageElement</span><br>keySize=0x08</td><td style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"4\"><span style=\"font-weight:400;font-style:normal\">leafPageElement</span><br>valSize=0x56</td></tr><tr><td style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\">0x00010020</td><td style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"8\">\"MyBucket\"<br><br>bucket的key</td><td style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"8\">bucket.root=0x00<br>与bucket.sequence一同构成bucket的val</td></tr><tr><td style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\">0x00010030</td><td style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"8\"><span style=\"font-weight:400;font-style:normal\">bucket.sequence=</span>0x00</td><td style=\"border-color:inherit;border-style:solid;border-width:1px;color:#fe0000;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"8\">0x00<br>虚拟页page id</td></tr><tr><td style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\"><span style=\"font-weight:400;font-style:normal\">0x00010030</span></td><td style=\"border-color:inherit;border-style:solid;border-width:1px;color:#fe0000;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"2\">0x02<br>虚拟页标识</td><td style=\"border-color:inherit;border-style:solid;border-width:1px;color:#fe0000;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"2\">0x20<br>count<br>虚拟页元素数量</td><td style=\"border-color:inherit;border-style:solid;border-width:1px;color:#fe0000;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"4\">0x00<br>overflow</td><td style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"4\">leafPageElement<br>flag=0x00</td><td style=\"border-color:inherit;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"4\">leafPageElement<br>pos=0x20</td></tr><tr><td style=\"border-color:black;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:left;vertical-align:top;word-break:normal\"><span style=\"font-weight:400;font-style:normal\">0x00010040</span></td><td style=\"border-color:black;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"4\">leafPageElement<br>keySize=0x05<br>key是name1</td><td style=\"border-color:black;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"4\">leafPageElement<br>valSize=0x06<br>val是nicky1</td><td style=\"border-color:black;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"4\">leafPageElement<br>flag=0x00</td><td style=\"border-color:black;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"4\">leafPageElement<br>pos=0x1b</td></tr><tr><td style=\"border-color:black;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\"><span style=\"font-weight:400;font-style:normal\">0x00010050</span></td><td style=\"border-color:black;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"4\">leafPageElement<br>keySize=0x05<br>key是name2</td><td style=\"border-color:black;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"4\">leafPageElement<br>valSize=0x06<br>val是nicky2</td><td style=\"border-color:black;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;text-align:center;vertical-align:top;word-break:normal\" colspan=\"8\">后面是真实的key,value</td></tr></tbody></table>\n<figure>rootBucket结构化数据</figure>\n<p>rootBucket存储在一个leafPage中，目前包括一个元素，这个元素是一个类型为bucket的leafPageElement，即概览图中的bucketElm。</p>\n<p>为什么bucketElm的val是0x56=86个字节呢？首先bucketElm与一般leafPageElement不同，value是一个结构体，在代码中表示为小写的bucket struct，包括一个8字节的root和一个8字节的序列号。\n而一般leafPageElement的value是用户写入的value。</p>\n<p>其次由于我们的kv少，符合bucket内联(inline page)的条件，root值为0。用户数据被作为一个虚拟页直接拼在了当前页的后面，这个页的大小也会被统计到value里面。</p>\n<pre><code class=\"hljs language-go\"><span class=\"hljs-comment\">// Bucket represents a collection of key/value pairs inside the database.</span>\n<span class=\"hljs-keyword\">type</span> Bucket <span class=\"hljs-keyword\">struct</span> {\n\t*bucket\n\ttx       *Tx                <span class=\"hljs-comment\">// the associated transaction</span>\n\tbuckets  <span class=\"hljs-keyword\">map</span>[<span class=\"hljs-type\">string</span>]*Bucket <span class=\"hljs-comment\">// subbucket cache</span>\n\tpage     *page              <span class=\"hljs-comment\">// inline page reference</span>\n\trootNode *node              <span class=\"hljs-comment\">// materialized node for the root page.</span>\n\tnodes    <span class=\"hljs-keyword\">map</span>[pgid]*node     <span class=\"hljs-comment\">// node cache</span>\n\n\t<span class=\"hljs-comment\">// Sets the threshold for filling nodes when they split. By default,</span>\n\t<span class=\"hljs-comment\">// the bucket will fill to 50% but it can be useful to increase this</span>\n\t<span class=\"hljs-comment\">// amount if you know that your write workloads are mostly append-only.</span>\n\t<span class=\"hljs-comment\">//</span>\n\t<span class=\"hljs-comment\">// This is non-persisted across transactions so it must be set in every Tx.</span>\n\tFillPercent <span class=\"hljs-type\">float64</span>\n}\n\n\n<span class=\"hljs-comment\">// bucket represents the on-file representation of a bucket.</span>\n<span class=\"hljs-comment\">// This is stored as the &quot;value&quot; of a bucket key. If the bucket is small enough,</span>\n<span class=\"hljs-comment\">// then its root page can be stored inline in the &quot;value&quot;, after the bucket</span>\n<span class=\"hljs-comment\">// header. In the case of inline buckets, the &quot;root&quot; will be 0.</span>\n<span class=\"hljs-keyword\">type</span> bucket <span class=\"hljs-keyword\">struct</span> {\n\troot     pgid   <span class=\"hljs-comment\">// page id of the bucket&#x27;s root-level page</span>\n\tsequence <span class=\"hljs-type\">uint64</span> <span class=\"hljs-comment\">// monotonically incrementing, used by NextSequence()</span>\n}\n</code></pre>\n<figure>bucket struct</figure>\n<p>有了这些基础，我们分析下val的总长度：</p>\n<pre><code class=\"hljs\"><span class=\"hljs-function\"><span class=\"hljs-title\">len</span>(<span class=\"hljs-variable\">value</span>)  = <span class=\"hljs-title\">len</span>(<span class=\"hljs-variable\">bucket</span> <span class=\"hljs-variable\">struct</span>) + <span class=\"hljs-title\">len</span>(虚拟页)</span>\n\t\t= <span class=\"hljs-number\">8</span>(<span class=\"hljs-variable\">root</span>) + <span class=\"hljs-number\">8</span>(<span class=\"hljs-variable\">sequence</span>) + <span class=\"hljs-function\"><span class=\"hljs-title\">len</span>(两个<span class=\"hljs-variable\">kv</span>的<span class=\"hljs-variable\">leafPage</span>)    \n\t\t= <span class=\"hljs-number\">8</span> + <span class=\"hljs-number\">8</span> + <span class=\"hljs-title\">len</span>(<span class=\"hljs-variable\">PH</span>) + <span class=\"hljs-number\">2</span> * <span class=\"hljs-title\">len</span>(<span class=\"hljs-variable\">leafPageElement</span>) + <span class=\"hljs-title\">len</span>(<span class=\"hljs-string\">&#x27;name1&#x27;</span> + <span class=\"hljs-string\">&#x27;nicky1&#x27;</span> + <span class=\"hljs-string\">&#x27;name2&#x27;</span> + <span class=\"hljs-string\">&#x27;nicky2&#x27;</span>)</span>\n\t\t= <span class=\"hljs-number\">8</span> + <span class=\"hljs-number\">8</span> + <span class=\"hljs-number\">16</span> + <span class=\"hljs-number\">2</span>*<span class=\"hljs-number\">16</span> + <span class=\"hljs-number\">22</span> = <span class=\"hljs-number\">86</span>\n</code></pre>\n<h2>总结</h2>\n<p>到这里Boltdb的几种核心数据结构及其二进制结构都分析完毕，后面我们看Boltdb的源码，是如何基于这些数据结构实现事务和MVCC等特性。</p>\n","title":"Boltdb数据结构-二进制存储","date":"2023-12-26","description":"对照二进制存储文件分析Boltdb的数据结构"}},"__N_SSG":true}